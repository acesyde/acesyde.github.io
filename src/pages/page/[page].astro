---
import HomeLayout from '../../layouts/HomeLayout.astro';
import ArticleCard from '../../components/ArticleCard.svelte';
import Pagination from '../../components/Pagination.svelte';
import { getCollection } from 'astro:content';

function generateExcerpt(body: string, maxLength: number = 200): string {
  if (!body) return '';
  
  // Remove markdown headers (lines starting with #)
  let text = body.replace(/^#{1,6}\s+.+$/gm, '');
  
  // Remove code blocks
  text = text.replace(/```[\s\S]*?```/g, '');
  
  // Remove inline code
  text = text.replace(/`[^`]+`/g, '');
  
  // Remove markdown links but keep the text
  text = text.replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1');
  
  // Remove images
  text = text.replace(/!\[([^\]]*)\]\([^\)]+\)/g, '');
  
  // Remove bold/italic markdown
  text = text.replace(/\*\*([^\*]+)\*\*/g, '$1');
  text = text.replace(/\*([^\*]+)\*/g, '$1');
  text = text.replace(/__([^_]+)__/g, '$1');
  text = text.replace(/_([^_]+)_/g, '$1');
  
  // Remove list markers
  text = text.replace(/^[\s]*[-*+]\s+/gm, '');
  text = text.replace(/^[\s]*\d+\.\s+/gm, '');
  
  // Clean up whitespace
  text = text.replace(/\n+/g, ' ').replace(/\s+/g, ' ').trim();
  
  // Truncate and add ellipsis if needed
  if (text.length > maxLength) {
    // Try to cut at a word boundary
    const truncated = text.substring(0, maxLength);
    const lastSpace = truncated.lastIndexOf(' ');
    if (lastSpace > maxLength * 0.8) {
      return truncated.substring(0, lastSpace) + '...';
    }
    return truncated + '...';
  }
  
  return text;
}

const POSTS_PER_PAGE = 10;
const page = Number(Astro.params.page) || 1;

const allPosts = (await getCollection('posts')).sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
);

const totalPages = Math.ceil(allPosts.length / POSTS_PER_PAGE);
const startIndex = (page - 1) * POSTS_PER_PAGE;
const endIndex = startIndex + POSTS_PER_PAGE;
const posts = allPosts.slice(startIndex, endIndex).map(post => ({
  post,
  excerpt: post.data.description || generateExcerpt(post.body || '', 200)
}));

// Redirect to home if page is 1 or invalid
if (page === 1 || page > totalPages || page < 1) {
  return Astro.redirect('/', 301);
}
---

<HomeLayout>
  <section class="posts-section">
    <div class="container">
      {posts.length > 0 ? (
        <>
          <div class="posts-list">
            {posts.map(({ post, excerpt }) => (
              <ArticleCard client:load post={post} excerpt={excerpt} />
            ))}
          </div>
          
          <Pagination client:load currentPage={page} totalPages={totalPages} />
        </>
      ) : (
        <p class="no-posts">Aucun article trouv√©.</p>
      )}
    </div>
  </section>
</HomeLayout>

<style>
  .posts-section {
    padding: var(--spacing-xl) 0 var(--spacing-2xl);
    background-color: var(--color-bg-tertiary);
    width: 100%;
  }
  
  .posts-list {
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  
  .no-posts {
    text-align: center;
    color: var(--color-text-secondary);
    padding: var(--spacing-2xl);
  }
</style>
